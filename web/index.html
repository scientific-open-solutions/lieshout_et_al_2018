<script src="jquery-3.5.1.min.js"></script>
<script src="papaparse.min.js"></script>

<style>
#top_circle{
  position: absolute;
  width: 485px;
  height:100px;
  border-radius:50%;
  background-color:#DBDADB;
  border-style: solid;
}

#jar_main{
  position: absolute;
  top: 50px;
  width: 475px;
  height: 650px;
  margin-left:5px;
  background-color:#DBDADB;
  border-radius: 0% 0% 15% 15%;
  border-style: solid;
}

.marble_class{
  position: absolute;
  width:100px;
  height:100px;
  border-radius:50px;
  background-color:mediumBlue;
}

#marble_legend_col1{
  top:  280px;
  left: 700px;
  background-color:firebrick;
}

#marble_legend_col2{
  top:  400px;
  left: 700px;
  background-color:mediumBlue;
}

.general_text{
  position: absolute;
   font-family:Calibri;
   font-size:40px;
}

#legend_val1{
  top:305px;
  left:820px;
}

#legend_val2{
  top:425px;
  left:820px;
}

.curious_option{
  position: absolute;
  width:100px;
  height:100px;
  justify-content: center;
  background-color:grey;
  border-radius: 15% 15% 15% 15%;
}

#curious_1{
  top: 50px;

}

#curious_2{
  position: absolute;
  top: 50px;
  left: 120;
}

#curious_3{
  position: absolute;
  top: 50px;
  left: 230;
}

#curious_4{
  position: absolute;
  top: 50px;
  left: 340;
}

.content{
   display: flex;
   align-items: center;
   justify-content: center;
   vertical-align: middle;
}

#outcome_marble{
    position: absolute;
    width:100px;
    height:100px;
    border-radius:50px;
    top:  120px;
    left: 25px;
    margin-top:-30px;
    background-color:firebrick;
}

#outcome_points{
  position: relative;
  font-family:Calibri;
  font-size:40px;
  top:200px;
  left:10px;

}

#phase_1,
#phase_2,
#phase_3{
  display:none;
}


</style>

<!-- use the stuff on the left for comments
  HTML here
-->
<div id="phase_1">
  <body style="background-color:powdergrey;">
  <div id="jar_main"></div>
  <div id="top_circle"></div>
  <div id="marble_0" class="marble_class"></div>
  <div id="marble_1" class="marble_class"></div>
  <div id="marble_2" class="marble_class"></div>
  <div id="marble_3" class="marble_class"></div>
  <div id="marble_4" class="marble_class"></div>
  <div id="marble_5" class="marble_class"></div>
  <div id="marble_6" class="marble_class"></div>
  <div id="marble_7" class="marble_class"></div>
  <div id="marble_8" class="marble_class"></div>
  <div id="marble_9" class="marble_class"></div>
  <div id="marble_10" class="marble_class"></div>
  <div id="marble_11" class="marble_class"></div>
  <div id="marble_12" class="marble_class"></div>
  <div id="marble_13" class="marble_class"></div>
  <div id="marble_14" class="marble_class"></div>
  <div id="marble_15" class="marble_class"></div>
  <div id="marble_16" class="marble_class"></div>
  <div id="marble_17" class="marble_class"></div>
  <div id="marble_18" class="marble_class"></div>
  <div id="marble_19" class="marble_class"></div>
  <div id="marble_legend_col1" class ="marble_class"></div>
  <div id="marble_legend_col2" class ="marble_class"></div>
  <div id="legend_val1" class = "general_text">N points</div>
  <div id="legend_val2" class = "general_text">N points</div>
</div>

<div id="phase_2">

  How curious were you? (1-4)
  <div id="curious_1" class="curious_option">
    <div class ="content">
      <p>1</p>
    </div>
  </div>
  <div id="curious_2" class="curious_option">
    <div class ="content">
      <p>2</p>
    </div>
  </div>
  <div id="curious_3" class="curious_option">
    <div class ="content">
      <p>3</p>
    </div>
  </div>
  <div id="curious_4" class="curious_option">
    <div class ="content">
      <p>4</p>
    </div>
  </div>
</div>


<div id="phase_3">
<div id="outcome_text" class="general_text">Outcome: </div>
<div id="outcome_marble"></div><br>
<div id="outcome_points">N points</div>
</div>

<script>

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

var data_obj ={
  current_trial: 0,
  participant_id : "tbc",
  responses: [],
  total_score : 0,
  total_score_array: [0],
  mobile: "tbc",
  date_start : "tbc",
  date_end: "tbc",
  browser: "tbc",
  order: "tbc",
  phase_3_triggered: false
}

$.get("Order1.csv",function(result){
  data_obj.order = Papa.parse(result, {header: true}).data;
  run_phase_0();
});

var trial_row;

function run_phase_0(){
  var marble_poses = [
    [120, 25],
    [120, 135],
    [120, 245],
    [120, 355],
    [230, 25],
    [230, 135],
    [230, 245],
    [230, 355],
    [340, 25],
    [340, 135],
    [340, 245],
    [340, 355],
    [450, 25],
    [450, 135],
    [450, 245],
    [450, 355],
    [560, 25],
    [560, 135],
    [560, 245],
    [560, 355],
  ];

  for(var i = 0; i < marble_poses.length; i++){
    $("#marble_" + i).css("top",marble_poses[i][0]+"px");
    $("#marble_" + i).css("left",marble_poses[i][1]+"px");
  }

  $("#phase_1").hide();
  $("#phase_2").hide();
  $("#phase_3").hide();

  trial_row = data_obj.order.shift();

  if(trial_row.main_color == "red"){
    trial_row.main_color = "firebrick";
    trial_row.other_color = "mediumBlue";
  } else {
    trial_row.main_color = "mediumBlue";
    trial_row.other_color = "firebrick";
  }

  var this_percentage = trial_row.n_main;
  var trial_points = trial_row.points_main;
  var trial_show = trial_row.show_no_show;

  var jar_color_order = Array(parseFloat(this_percentage)).fill(trial_row.main_color)
                              .concat(Array(20-parseFloat(this_percentage))
                              .fill(trial_row.other_color))

  shuffleArray(jar_color_order);

  /* Added jitter to marble position */
  var jitter_max = 5
  var jitter_min = -5

  for(i=0; i< jar_color_order.length;i++){
    $("#marble_"+i).css("background-color",jar_color_order[i]);
    old_top = $("#marble_"+i).css("top");
    old_left = $("#marble_"+i).css("left");
    $("#marble_"+i).css(
      "top",
      (parseInt(old_top,10) +
        Math.floor(
          Math.random() * (jitter_max - jitter_min + 1)
        ) +
        jitter_min) +
        "px");
    $("#marble_"+i).css("left",(parseInt(old_left,10) + Math.floor(Math.random() * (jitter_max - jitter_min + 1)) + jitter_min) + "px");
  };
  run_phase_1();
}

/*
* Phase 1
*/
function run_phase_1(){
  $("#phase_0").hide();
  $("#phase_2").hide();
  $("#phase_3").hide();

if(trial_row.main_color == "firebrick"){
  document.getElementById("legend_val1").innerHTML = trial_row.points_main + " points";
  document.getElementById("legend_val2").innerHTML = 100 - trial_row.points_main + " points";
} else {
  document.getElementById("legend_val1").innerHTML = 100 - trial_row.points_main + " points";
  document.getElementById("legend_val2").innerHTML = trial_row.points_main + " points";
}

  $("#phase_1").show();

  setTimeout(function(){
    $("#phase_1").hide();
    setTimeout(function(){
      run_phase_2()
    },500);
  },3000);
}

/*
* Phase 2
*/
function run_phase_2(){
  $("#phase_1").hide();
  $("#phase_2").hide();
  $("#phase_3").hide();

  $("#phase_2").show();
  setTimeout(function(){
    $("#phase_2").hide();
    setTimeout(function(){
      if(data_obj.phase_3_triggered == false){
        run_phase_3();
      }
    },500);
  },4000);
}


/*
* Phase 3
*/
function run_phase_3(){
  $("#phase_0").hide();
  $("#phase_1").hide();
  $("#phase_2").hide();

  if(trial_row.show_no_show == "noShow"){
    outcome_colour = "black";
    outcome_points_text = "?? points";
  } else if (trial_row.show_no_show == "show"){
    outcome_points = trial_row.win_points;
    outcome_colour = trial_row.win_color;
    outcome_points_text = outcome_points + " points";
  }

  $("#outcome_marble").css("background-color",outcome_colour);
  document.getElementById("outcome_points").innerHTML = outcome_points_text;


  $("#phase_3").show();
  setTimeout(function(){
    data_obj.current_trial++;
    run_phase_0();
  },2000);
}


$(".curious_option").on("click",function(){
  data_obj.responses[data_obj.current_trial] = this.id;

});

/*
* Send data
*/
function send_data(this_data, this_participant){
  $.post("http://kousos-org.stackstaging.com/server_h38s7ahsdje67fgwhe5.php", {
    "data":        this_data,
    "experiment":  "lieshoult_2018",
    "participant": this_participant
  }, function(result){
    if(result !== "success"){
      alert(result);
    }
  });
}
</script>
